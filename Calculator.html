<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #ffffff; }
    .container { max-width: 520px; margin: 40px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,.2); }

    /* Global controls (top selects/buttons) */
    select, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      height: 40px;
      box-sizing: border-box;
    }
    /* Global buttons (but NOT the Add Flight button) */
    button:not(#addFlightBtn):not(.deleteBtn) {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      height: 40px;
      box-sizing: border-box;
      background-color: #D32F2F;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: .3s;
    }

    .result { font-size: 20px; font-weight: bold; margin-top: 20px; color: #000; }
    .note { font-size: 13px; color: #555; margin-top: 4px; }
    .donation-message { margin-top: 5px; font-size: 13px; color: #333; font-family: "Times New Roman", Times, serif; }
    .random-image { width: 200px; height: 200px; margin-top: 10px; }
    .qr-image { width: 100px; height: 100px; margin-top: 10px; }
    .visitor-counter { position: fixed; bottom: 10px; right: 10px; background: white; padding: 5px 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,.2); }

    /* Per-flight rows */
    .routeWrapper {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      align-items: start;
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafafa;
      text-align: left;
    }
    .flightLabel {
      font-weight: bold;
      font-size: 16px;
      grid-column: 1 / -1;
      margin-bottom: 6px;
    }

    /* Row 1: flight dropdown fills line, delete fixed at end */
    .routeRowTop {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .routeDropdown {
      flex: 1;
      min-width: 0;
      height: 40px;
      font-size: 14px;
      padding: 6px 8px;
      margin-top: 0;
    }
    .deleteBtn {
      flex: 0 0 32px;
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: #e0e0e0;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0;
    }

    /* Row 2: Layover + DHC */
    .routeOptions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .optGroup {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
    }
    .optGroup label { font-size: 14px; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px; }
    .pill { padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; }
    .layoverDuration.pill {
      width: 110px !important;
      height: 36px;
      font-size: 14px;
      margin-top: 0;
    }
    .deadheadDirection.pill {
      width: 150px !important;
      height: 36px;
      font-size: 14px;
      margin-top: 0;
    }

    /* Make the Add Flight button look subtle/secondary */
    #addFlightBtn {
      background: transparent;
      border: 1px dashed #aaa;
      color: #555;
      font-weight: normal;
      margin-top: 16px;
    }

    #addFlightBtn:hover {
      background: #f2f2f2;
      border-color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculator<br>(Routes Updated)</h2>

    <div id="routeContainer"></div>
    <button id="addFlightBtn" type="button">+ Add flight</button>

    <label for="sickLeave" style="margin-top:20px;font-weight:bold;font-size:16px;margin-bottom:8px;display:block;">Sick Leave?</label>
    <select id="sickLeave">
      <option>No SL</option>
      <option>1 Day SL</option>
      <option>2 Days SL</option>
      <option>2 Days in Hospital</option>
    </select>

    <label for="includeCommission" style="margin-top:10px;font-weight:bold;font-size:16px;display:block;">
      <input type="checkbox" id="includeCommission"> Include Commission
    </label>

    <button onclick="calculateIncome()">Calculate</button>

    <div class="result" id="incomeResult">Total Income: </div>
    <div class="result" id="blockHoursResult">Total Block Hours: </div>
    <div class="note">(*Block hours include only operating hours)</div>

    <img src="reset-icon.png" onclick="resetForm()" style="width:20px;height:20px;cursor:pointer;display:block;margin:10px auto;" alt="Reset">

    <img id="randomImage" class="random-image" src="" alt="Random Image">
    <div class="donation-message">สแกนสมทบทุนซื้อเปียกๆ เพื่อยูซุ</div>
    <img src="qr.jpg" class="qr-image" alt="QR Image">
  </div>

<script>
const dataArray = [
  { 'Routes': 'CTS', 'Block hours Outbound': 6.08, 'Block hours Inbound': 8.17 },
  { 'Routes': 'ICN', 'Block hours Outbound': 5.58, 'Block hours Inbound': 6.17 },
  { 'Routes': 'NRT', 'Block hours Outbound': 6.08, 'Block hours Inbound': 7.42 },
  { 'Routes': 'KIX', 'Block hours Outbound': 5.42, 'Block hours Inbound': 5.50 },
  { 'Routes': 'PVG', 'Block hours Outbound': 4.25, 'Block hours Inbound': 4.67 },
  { 'Routes': 'NGO', 'Block hours Outbound': 5.83, 'Block hours Inbound': 6.75 },
  { 'Routes': 'DEL', 'Block hours Outbound': 4.50, 'Block hours Inbound': 4.08 },
  { 'Routes': 'SDJ', 'Block hours Outbound': 6.25, 'Block hours Inbound': 7.50 },
  { 'Routes': 'ALA', 'Block hours Outbound': 7.17, 'Block hours Inbound': 6.67 },
  { 'Routes': 'RUH', 'Block hours Outbound': 8.33, 'Block hours Inbound': 7.17 },
  { 'Routes': 'HRB', 'Block hours Outbound': 5.83, 'Block hours Inbound': 6.50 },
];

function toMinutes(decimalHours) {
  return Math.round(decimalHours * 60);
}
function formatHM(totalMinutes) {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return `${h}h ${String(m).padStart(2, '0')}m`;
}

function populateDropdown(dropdown) {
  dropdown.innerHTML = '<option value="">-- Select your Flight --</option>';
  const filtered = dataArray
    .map(r => r.Routes)
    .filter(code => !(code.endsWith('2') || code.endsWith('3')));
  filtered.sort().forEach(route => {
    const opt = document.createElement("option");
    opt.value = route;
    opt.textContent = route;
    dropdown.appendChild(opt);
  });
}

function addRouteDropdown() {
  const container = document.getElementById("routeContainer");

  const wrapper = document.createElement("div");
  wrapper.className = "routeWrapper";

  const label = document.createElement("div");
  label.className = "flightLabel";
  label.textContent = "Flight";
  wrapper.appendChild(label);

  const rowTop = document.createElement("div");
  rowTop.className = "routeRowTop";

  const newDropdown = document.createElement("select");
  newDropdown.className = "routeDropdown";
  populateDropdown(newDropdown);

  const deleteBtn = document.createElement("button");
  deleteBtn.className = "deleteBtn";
  deleteBtn.textContent = "✖";
  deleteBtn.title = "Remove this flight";
  deleteBtn.onclick = () => {
    const wrappers = document.querySelectorAll(".routeWrapper");
    if (wrappers.length > 1) wrapper.remove();
    else alert("No flights? Why are you even here?");
  };

  rowTop.appendChild(newDropdown);
  rowTop.appendChild(deleteBtn);
  wrapper.appendChild(rowTop);

  const optionsRow = document.createElement("div");
  optionsRow.className = "routeOptions";
  optionsRow.style.display = "none";

  const layGroup = document.createElement("div");
  layGroup.className = "optGroup";
  const layCheckbox = document.createElement("input");
  layCheckbox.type = "checkbox";
  layCheckbox.className = "layoverCheckbox";
  layCheckbox.checked = true;

  const layLbl = document.createElement("label");
  layLbl.textContent = "Layover?";
  layLbl.prepend(layCheckbox);

  const layHours = document.createElement("select");
  layHours.className = "layoverDuration pill";
  layHours.innerHTML = `
    <option value="24">24 hrs</option>
    <option value="48">48 hrs</option>
    <option value="72">72 hrs</option>
  `;
  layHours.value = "24";
  layHours.style.display = layCheckbox.checked ? "inline-block" : "none";

  /* ✅ Simple checkbox handler (no forcing) */
  layCheckbox.addEventListener("change", () => {
    layHours.style.display = layCheckbox.checked ? "inline-block" : "none";
    if (layCheckbox.checked) layHours.value = "24";
  });

  layGroup.appendChild(layLbl);
  layGroup.appendChild(layHours);

  const dhcGroup = document.createElement("div");
  dhcGroup.className = "optGroup";
  const dhcCheckbox = document.createElement("input");
  dhcCheckbox.type = "checkbox";
  dhcCheckbox.className = "deadheadCheckbox";

  const dhcLbl = document.createElement("label");
  dhcLbl.textContent = "DHC?";
  dhcLbl.prepend(dhcCheckbox);

  const dirSelect = document.createElement("select");
  dirSelect.className = "deadheadDirection pill";
  dirSelect.innerHTML = `
    <option value="">-- Operating? --</option>
    <option value="outbound">Outbound</option>
    <option value="inbound">Inbound</option>
  `;
  dirSelect.style.display = "none";
  dhcCheckbox.addEventListener("change", () => {
    dirSelect.style.display = dhcCheckbox.checked ? "inline-block" : "none";
    if (!dhcCheckbox.checked) dirSelect.value = "";
  });

  dhcGroup.appendChild(dhcLbl);
  dhcGroup.appendChild(dirSelect);

  optionsRow.appendChild(layGroup);
  optionsRow.appendChild(dhcGroup);
  wrapper.appendChild(optionsRow);

  /* ✅ Initialize: DEL starts unchecked (user can re-check) */
  newDropdown.onchange = function () {
    optionsRow.style.display = newDropdown.value !== "" ? "flex" : "none";

    if (newDropdown.value === "") {
      // reset to defaults
      layCheckbox.checked = true;
      layHours.value = "24";
      layHours.style.display = "inline-block";
      dhcCheckbox.checked = false;
      dirSelect.style.display = "none";
      dirSelect.value = "";
    } else if (newDropdown.value === "DEL") {
      layCheckbox.checked = false;      // start unchecked
      layHours.style.display = "none";  // hidden until user checks
    } else {
      // normal routes default to layover 24h
      layCheckbox.checked = true;
      layHours.value = "24";
      layHours.style.display = "inline-block";
    }
  };

  container.appendChild(wrapper);
}

function createFirstDropdown() {
  addRouteDropdown();
}

function calculateIncome() {
  const sickLeave = document.getElementById("sickLeave").value;
  let totalIncome = 0, totalBlockMinutes = 0;
  const sickLeaveMultiplier = {
    "No SL": 100,
    "1 Day SL": 90,
    "2 Days SL": 0,
    "2 Days in Hospital": 60
  };
  const includeCommission = document.getElementById("includeCommission").checked;

  const wrappers = document.querySelectorAll(".routeWrapper");
  for (const wrapper of wrappers) {
    const route = wrapper.querySelector(".routeDropdown").value;
    const isDeadhead = wrapper.querySelector(".deadheadCheckbox").checked;
    const hasLayover = wrapper.querySelector(".layoverCheckbox")?.checked ?? true;
    const layoverHours = parseInt(wrapper.querySelector(".layoverDuration")?.value || "24", 10);
    const direction = wrapper.querySelector(".deadheadDirection").value;

    const selectedData = dataArray.find(r => r.Routes === route);
    if (!route || !selectedData) continue;

    if (isDeadhead && !direction) {
      alert(`Please select whether you are operating Outbound or Inbound for flight ${route}`);
      return;
    }

    const outboundMin = toMinutes(selectedData["Block hours Outbound"]);
    const inboundMin  = toMinutes(selectedData["Block hours Inbound"]);

    let operatedMin = 0, deadheadMin = 0;
    if (!isDeadhead) {
      operatedMin = outboundMin + inboundMin;
    } else {
      if (direction === "outbound") {
        operatedMin = outboundMin;
        deadheadMin = inboundMin;
      } else {
        operatedMin = inboundMin;
        deadheadMin = outboundMin;
      }
    }

    const operatedHours = operatedMin / 60;
    const deadheadHours = deadheadMin / 60;

    const basePay      = operatedHours * 250;
    const sickLeavePay = operatedHours * sickLeaveMultiplier[sickLeave];

    const sectorAllowance = isDeadhead ? 300 : 600;
    const commission      = includeCommission ? 500 : 0;

    const operatedSectors = isDeadhead ? 1 : 2;
    const transportationAllowance = 350 * operatedSectors;

    let overnightAllowance = 0;
    if (hasLayover) {
      const multiplier = layoverHours === 72 ? 3 : layoverHours === 48 ? 2 : 1;
      overnightAllowance = 2880 * multiplier;
    }

    let extraAllowance = 0;
    if (route === "PVG" && !hasLayover) {
      extraAllowance = 1000;
    }

    const deadheadPay = deadheadHours * 250;

    const routeIncome =
      basePay +
      sickLeavePay +
      sectorAllowance +
      transportationAllowance +
      commission +
      overnightAllowance +
      extraAllowance +
      deadheadPay;

    totalIncome += routeIncome;
    totalBlockMinutes += operatedMin; // operating only
  }

  document.getElementById("incomeResult").textContent =
    `Total Income: ${totalIncome.toFixed(2)}`;

  document.getElementById("blockHoursResult").textContent =
    `Total Block Hours: ${formatHM(totalBlockMinutes)}`;
}

document.addEventListener("DOMContentLoaded", function () {
  createFirstDropdown();
  document.getElementById("addFlightBtn").addEventListener("click", addRouteDropdown);

  const images = ["img1.jpg","img2.jpg","img3.jpg","img4.jpg","img5.jpg","img6.jpg","img7.jpg","img8.jpg","img9.jpg","img10.jpg"];
  document.getElementById("randomImage").src = images[Math.floor(Math.random() * images.length)];
});

function resetForm() {
  location.reload();
}
</script>

  <div class="visitor-counter">
    <img src="https://api.visitorbadge.io/api/visitors?path=https%3A%2F%2Fpimdays.github.io%2Fdoeseverything%2FCalculator&label=Visits&labelColor=%23d9e3f0&countColor=%23d9e3f0" alt="Visitor Counter">
  </div>
</body>
</html>
